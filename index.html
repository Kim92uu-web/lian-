<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„AIå°æ‰‹æœº</title>
    <style>
        /* ======================================= */
        /* === å¼•å…¥è‡ªå®šä¹‰å­—ä½“ (å·²ä¿®æ­£è·¯å¾„) === */
        /* ======================================= */
        @font-face {
            font-family: 'GenYoGothicTW'; 
            /* å‡è®¾ GenYoGothicTW-R.ttf æ”¾åœ¨äº†æ ¹ç›®å½• */
            src: url('GenYoGothicTW-R.ttf') format('truetype'); 
            font-weight: normal;
            font-style: normal;
        }

        /* === åŸºç¡€è®¾ç½® === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background-color: #f0f2f5;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; 
            /* å¼•ç”¨æ‚¨çš„è‡ªå®šä¹‰å­—ä½“ */
            font-family: 'GenYoGothicTW', "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", sans-serif;
            overflow: hidden; 
        }

        /* === æ‰‹æœºå¤–å£³ === */
        .phone-case {
            width: 320px; height: 650px;
            background: #111;
            border-radius: 45px;
            box-shadow: 0 0 0 10px #333, 0 20px 50px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
            border: 2px solid #444;
        }

        /* === å±å¹•åŒºåŸŸ === */
        .screen {
            width: 100%; height: 100%;
            /* é»˜è®¤å£çº¸ - é¦–æ¬¡åŠ è½½æ—¶ä¼šè¢« localStorage è¦†ç›– */
            background: url('https://img.baidu.re/i/2025/12/guvqaq.jpeg') no-repeat center center/cover;
            position: relative; overflow: hidden;
        }

        /* === 1. é¡¶éƒ¨çŠ¶æ€æ  === */
        .status-bar-area {
            position: absolute; top: 0; left: 0; width: 100%; height: 40px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 25px; font-size: 14px; color: white;
            z-index: 500; font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* === 2. çµåŠ¨å²› (æ ¸å¿ƒäº¤äº’åŒº) === */
        .dynamic-island-trigger {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            width: 100px; height: 30px;
            background: #000; border-radius: 20px;
            z-index: 600; cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; justify-content: center;
            background-size: cover; background-position: center;
        }
        /* å±•å¼€çŠ¶æ€ */
        .dynamic-island-trigger.expanded {
            width: 280px; height: 170px; 
            border-radius: 35px; padding: 15px;
            flex-direction: column; justify-content: flex-start;
            background-color: #000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .island-content {
            display: none; flex-direction: column; align-items: center;
            width: 100%; height: 100%; color: white;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        
        /* çµåŠ¨å²›å†…å…ƒç´  */
        .island-avatar { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 5px; object-fit: cover; border: 2px solid #fff; }
        .island-input {
            width: 90%; height: 30px; background: rgba(255,255,255,0.2);
            border: none; border-radius: 8px; color: white; text-align: center;
            margin-top: 8px; font-size: 12px;
        }
        .island-input::placeholder { color: rgba(255,255,255,0.7); }
        
        /* æŒ‰é’®ç»„ */
        .island-btn-group { display: flex; gap: 15px; margin-top: 10px; }
        .img-btn {
            width: 40px; height: 40px; border-radius: 10px;
            cursor: pointer; transition: 0.2s; border: 1px solid rgba(255,255,255,0.3);
            object-fit: contain; background: rgba(255,255,255,0.1); padding: 2px;
        }
        .img-btn:active { transform: scale(0.9); }

        /* è¯­éŸ³æ°”æ³¡ */
        .audio-bubble {
            background: rgba(255,255,255,0.95); color: #000;
            padding: 5px 12px; border-radius: 15px; font-size: 12px;
            margin-bottom: 5px; max-width: 90%;
            display: none; 
        }

        /* === 3. æ¡Œé¢ç¿»é¡µå®¹å™¨ === */
        .desktop-slider {
            display: flex;
            width: 100%; height: 100%;
            overflow-x: auto; 
            scroll-snap-type: x mandatory; 
            scrollbar-width: none; 
            padding-top: 70px; 
            z-index: 10;
        }
        .desktop-slider::-webkit-scrollbar { display: none; }
        
        .page {
            min-width: 100%; 
            height: 100%;
            scroll-snap-align: start; 
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: repeat(4, 80px);   
            padding: 10px;
            align-content: start;
        }

        /* è½¯ä»¶å›¾æ ‡æ ·å¼ */
        .app-icon {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; text-decoration: none; color: white;
            font-size: 11px; text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            margin-bottom: 10px; cursor: pointer;
        }
        .app-icon img {
            width: 52px; height: 52px;
            border-radius: 12px; margin-bottom: 5px;
            background: rgba(255,255,255,0.2);
            object-fit: cover;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .app-icon:active img { filter: brightness(0.8); transform: scale(0.95); }

        /* === 4. åº”ç”¨çª—å£ (ç‚¹è¿›å»åçš„é¡µé¢) === */
        .app-window {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 800;
            display: none; flex-direction: column;
            animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .app-header {
            height: 80px; background: #f8f8f8;
            padding-top: 40px; text-align: center; font-weight: bold;
            border-bottom: 1px solid #eee;
        }
        /* å¸ƒå±€æ¾å¼›å’Œå…¨å±€è¾¹è·ä¼˜åŒ– */
        .app-body { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
            color: #333; 
        }

        /* === 5. åº•éƒ¨ç™½æ¡ (ä¿®å¤ç‰ˆï¼šç»å¯¹ç½®é¡¶) === */
        .home-indicator {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 50px;
            display: flex; justify-content: center; align-items: flex-end;
            padding-bottom: 10px; z-index: 9999; cursor: pointer;
        }
        .home-bar {
            width: 130px; height: 5px; background: white;
            border-radius: 100px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .app-active .home-bar { background: #222; }

        /* ======================================= */
        /* === è®¾ç½®èœå•å’Œ API ç•Œé¢æ ·å¼ä¼˜åŒ– === */
        /* ======================================= */
        
        h2 {
            margin-bottom: 20px; 
            letter-spacing: 0.5px;
        }

        /* 1. è®¾ç½®ä¸»èœå•é“¾æ¥ä¼˜åŒ– */
        .setting-link-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 0; 
            color: #333;
            text-decoration: none;
            border-bottom: 1px solid #f0f0f0;
            font-size: 16px; 
        }
        .setting-link-item:last-child { border-bottom: none; }
        .setting-link-item:active { background-color: #f8f8f8; }
        .setting-link-item .arrow { color: #ccc; font-weight: 300; }
        .setting-link-item .text { letter-spacing: 0.2px; }

        /* 2. é…ç½®ç»„é—´è·ä¼˜åŒ– */
        .setting-group { margin-bottom: 25px; }

        /* 3. æ ‡ç­¾ï¼ˆLabelï¼‰ä¼˜åŒ– */
        .api-label {
            margin-bottom: 10px; 
            font-size: 15px; 
            color: #333; 
            letter-spacing: 0.5px; 
        }

        /* 4. è¾“å…¥æ¡†/ä¸‹æ‹‰æ¡†ä¼˜åŒ– */
        .api-input,
        .api-select {
            display: block; 
            width: 100%;
            padding: 12px 12px; 
            font-size: 15px;
            border: 1px solid #ddd;
            border-radius: 10px; 
        }

        /* 5. æŒ‰é’®ä¼˜åŒ– */
        .api-button {
            width: 100%; 
            padding: 14px; 
            margin-top: 15px; 
            font-size: 16px;
            border: none;
            border-radius: 10px;
            background-color: #007aff;
            color: white;
            cursor: pointer;
            transition: 0.2s;
            letter-spacing: 0.8px; 
        }
        .api-button:active { filter: brightness(0.9); }

        /* 6. çŠ¶æ€ä¿¡æ¯ä¼˜åŒ– */
        .status-message {
            margin-top: 20px;
            padding: 15px;
            font-size: 14px;
            line-height: 1.6; 
            border-radius: 10px;
            background-color: #f8f8f8;
            text-align: center;
        }
        .status-message.success { background-color: #e6ffed; color: #008000; }
        .status-message.error { background-color: #ffe6e6; color: #d90000; }

        /* ======================================= */
        /* === å£çº¸è®¾ç½®ç•Œé¢ç¼©ç•¥å›¾æ ·å¼ === */
        /* ======================================= */
        .preset-wallpaper-thumb {
            width: 70px; 
            height: 100px; 
            object-fit: cover; 
            border-radius: 8px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .preset-wallpaper-thumb:hover,
        .preset-wallpaper-thumb:active {
            border-color: #007aff; 
            transform: scale(1.05);
        }

        /* ======================================= */
        /* === AI èŠå¤©ç•Œé¢æ ·å¼ (å¾®ä¿¡é£æ ¼) === */
        /* ======================================= */

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #f7f7f7; /* æµ…ç°è‰²èƒŒæ™¯ï¼Œæ¨¡ä»¿å¾®ä¿¡/QQ */
        }

        /* å•æ¡æ¶ˆæ¯çš„å®¹å™¨ */
        .message-row {
            display: flex;
            margin-bottom: 15px;
        }
        /* æ¥æ”¶è€… (AI) */
        .message-row.left { justify-content: flex-start; }
        /* å‘é€è€… (ç”¨æˆ·) */
        .message-row.right { justify-content: flex-end; }

        /* å¤´åƒæ ·å¼ */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 10px;
        }
        .message-row.left .avatar { margin-right: 5px; }
        .message-row.right .avatar { margin-left: 5px; }

        /* æ°”æ³¡æ ·å¼ */
        .message-bubble {
            max-width: 70%;
            padding: 10px 12px;
            border-radius: 10px;
            position: relative;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        /* AI æ°”æ³¡ï¼ˆæµ…è‰²ï¼‰ */
        .message-row.left .message-bubble {
            background-color: #fff;
            border-top-left-radius: 3px; /* é¡¶éƒ¨å·¦ä¾§å°–è§’æ•ˆæœ */
            color: #333;
        }
        /* ç”¨æˆ·æ°”æ³¡ï¼ˆæ·±è‰²/ä¸»é¢˜è‰²ï¼‰ */
        .message-row.right .message-bubble {
            background-color: #a9e875; /* å¾®ä¿¡ç»¿è‰²ä¸»é¢˜ */
            border-top-right-radius: 3px; /* é¡¶éƒ¨å³ä¾§å°–è§’æ•ˆæœ */
            color: #333;
        }

        /* === è¾“å…¥åŒºåŸŸ === */
        .chat-input-area {
            height: 50px;
            background-color: #f9f9f9;
            border-top: 1px solid #ddd;
            display: flex;
            align-items: center;
            padding: 5px 10px;
        }
        .chat-input-area input[type="text"] {
            flex: 1;
            height: 38px;
            padding: 0 15px;
            border: none;
            background-color: #fff;
            border-radius: 20px;
            margin-right: 8px;
            font-size: 15px;
            outline: none;
        }
        /* è¯­éŸ³/å‘é€æŒ‰é’® */
        .chat-action-btn {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            color: #555;
            transition: 0.1s;
        }
        .chat-action-btn:active { transform: scale(0.9); }

        /* å‘é€æŒ‰é’®ä¸»é¢˜è‰² */
        .send-btn {
            background-color: #07c160; /* å¾®ä¿¡ä¸»é¢˜ç»¿è‰² */
            color: white;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
        }

    </style>
</head>
<body onload="initialize()"> <div class="phone-case">
        <div class="screen">
            
            <div class="status-bar-area">
                <span id="clock">12:00</span>
                <span style="pointer-events: none;">
                    <span id="weather">â˜€ï¸</span> 
                    <span id="battery">100%</span>
                </span>
            </div>

            <div class="dynamic-island-trigger" id="island" onclick="toggleIsland()">
                <div class="island-content" id="islandContent" onclick="event.stopPropagation()">
                    <img src="https://img.baidu.re/i/2025/12/gyw9xz.jpeg" id="islandAvatar" class="island-avatar">
                    
                    <div id="audioBubble" class="audio-bubble"></div>
                    
                    <div class="island-btn-group">
                        <img src="https://img.baidu.re/i/2025/12/gxultd.png" class="img-btn" onclick="changeIsland('kuromi', event)">
                        <img src="https://img.baidu.re/i/2025/12/gxvoni.png" class="img-btn" onclick="changeIsland('bear', event)">
                        <img src="https://img.baidu.re/i/2025/12/gxw6h4.png" class="img-btn" onclick="changeIsland('clover', event)">
                    </div>

                    <input type="text" class="island-input" placeholder="ç‚¹å‡»è¿™é‡Œä¿®æ”¹æ–‡æ¡ˆ..." onchange="updateText(this.value)">
                </div>
            </div>

            <div class="desktop-slider">
                
                <div class="page page-1">
                    <div class="app-icon" onclick="openApp('ai-app')">
                        <img src="https://img.baidu.re/i/2025/12/gw1n4f.jpeg">
                        <span>AIåŠ©æ‰‹</span>
                    </div>
                    <div class="app-icon" onclick="openApp('settings-app')">
                        <img src="https://img.baidu.re/i/2025/12/gvj0se.jpeg">
                        <span>è®¾ç½®</span>
                    </div>
                    <div class="app-icon" onclick="openApp('gallery-app')">
                        <img src="https://img.baidu.re/i/2025/12/gw27ij.jpeg">
                        <span>ç›¸å†Œ</span>
                    </div>
                    <div class="app-icon" onclick="openApp('music-app')">
                        <img src="https://img.baidu.re/i/2025/12/gw2drc.jpeg">
                        <span>éŸ³ä¹</span>
                    </div>
                    <div class="app-icon" onclick="openApp('forum-app')">
                        <img src="https://img.baidu.re/i/2025/12/gw2t70.jpeg">
                        <span>è®ºå›</span>
                    </div>
                    <div class="app-icon" onclick="openApp('extra-app')">
                        <img src="https://img.baidu.re/i/2025/12/gw34t4.jpeg">
                        <span>ç•ªå¤–å‰§åœº</span>
                    </div>
                </div>

                <div class="page page-2" style="display:flex; justify-content:center; align-items:center; color:rgba(255,255,255,0.5);">
                    <div style="text-align:center;">
                        <div style="font-size:40px; margin-bottom:10px;">ğŸ“…</div>
                        <span>å¾…åŠäº‹é¡¹</span>
                    </div>
                </div>

            </div>

            <div id="ai-app" class="app-window">
                <div class="app-header">AI èŠå¤©åŠ©æ‰‹</div>
                
                <div class="chat-container" id="ai-chat-container">
                    </div>
                
                <div class="chat-input-area">
                    <span class="chat-action-btn">ğŸ¤</span>
                    <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                    <span class="chat-action-btn send-btn" id="send-btn">å‘é€</span>
                </div>
                
            </div>

            <div id="settings-app" class="app-window">
                <div class="app-header">ç³»ç»Ÿè®¾ç½®</div>
                <div class="app-body">
                    
                    <div id="settings-main-menu">
                        <a href="#" onclick="loadApiSettings(event)" class="setting-link-item">
                            <span class="text">ğŸ¤– AI æœåŠ¡å•†é…ç½®</span>
                            <span class="arrow">></span>
                        </a>
                        <a href="#" onclick="openWallpaperSettings(event)" class="setting-link-item">
                            <span class="text">ğŸ“± ä¿®æ”¹æ‰‹æœºå£çº¸</span>
                            <span class="arrow">></span>
                        </a>
                        <a href="#" onclick="openWidgetSettings(event)" class="setting-link-item">
                            <span class="text">ğŸ§© å°ç»„ä»¶ç®¡ç†</span>
                            <span class="arrow">></span>
                        </a>
                    </div>
                    
                    <div id="settings-sub-page" style="display:none;">
                        </div>

                </div>
            </div>
            
            <div id="gallery-app" class="app-window">
                <div class="app-header">æˆ‘çš„ç›¸å†Œ</div>
                <div class="app-body">ç›¸å†Œå†…å®¹åŠ è½½ä¸­...</div>
            </div>
            
            <div id="music-app" class="app-window">
                <div class="app-header">éŸ³ä¹æ’­æ”¾å™¨</div>
                <div class="app-body">ğŸµ æ­£åœ¨æ’­æ”¾: With You</div>
            </div>

            <div id="forum-app" class="app-window">
                <div class="app-header">ç¤¾åŒºè®ºå›</div>
                <div class="app-body">æ¬¢è¿æ¥åˆ°è®¨è®ºåŒº...</div>
            </div>

            <div id="extra-app" class="app-window">
                <div class="app-header">ç•ªå¤–å‰§åœº</div>
                <div class="app-body">é€‰æ‹©ä½ çš„è§’è‰²æ‰®æ¼”å‰§æœ¬...</div>
            </div>

            <div class="home-indicator" id="homeBtn" onclick="handleHomeClick(event)">
                <div class="home-bar"></div>
            </div>

        </div>
    </div>

    <script>
        // =====================================================
        // === [æŒä¹…åŒ–] å…¨å±€åˆå§‹åŒ–å’Œæ•°æ®æŒä¹…åŒ–è¾…åŠ©å‡½æ•° ===
        // =====================================================
        
        // è¾…åŠ©å‡½æ•°ï¼šä» localStorage åŠ è½½æ•°æ®
        function loadSetting(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                console.error("æ— æ³•è®¿é—® localStorage: ", e);
                return null;
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šå°†æ•°æ®ä¿å­˜åˆ° localStorage
        function saveSetting(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (e) {
                console.error("æ— æ³•ä¿å­˜åˆ° localStorage: ", e);
            }
        }

        // é¡µé¢å¯åŠ¨æ—¶æ‰§è¡Œçš„åˆå§‹åŒ–å‡½æ•°
        function initialize() {
            updateTime(); // å¯åŠ¨æ—¶é’Ÿ
            loadSavedWallpaper(); // åŠ è½½å·²ä¿å­˜çš„å£çº¸
        }
        
        // [æ–°å¢] è·å–å½“å‰å·²ä¿å­˜çš„ AI é…ç½®
        function getCurrentApiConfig() {
            return {
                provider: loadSetting('api_provider'),
                key: loadSetting('api_key'),
                url: loadSetting('api_url'),
                model: loadSetting('api_model')
            };
        }

        // =====================================================
        // === 1. æ—¶é—´ä¸å¤©æ°”é€»è¾‘ ===
        // =====================================================
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock').innerText = timeStr;
            
            const weathers = ['â˜€ï¸', 'â˜ï¸', 'ğŸŒ§ï¸', 'âš¡', 'â„ï¸'];
            if(Math.random() > 0.9) {
                document.getElementById('weather').innerText = weathers[Math.floor(Math.random() * weathers.length)];
            }
        }
        setInterval(updateTime, 1000);
        
        // === 2. çµåŠ¨å²›é€»è¾‘ (ä¿æŒä¸å˜) ===
        const island = document.getElementById('island');
        const islandContent = document.getElementById('islandContent');
        const audioBubble = document.getElementById('audioBubble');
        const islandAvatar = document.getElementById('islandAvatar');
        let islandState = false;

        const islandConfig = {
            'kuromi': {
                img: 'https://img.baidu.re/i/2025/12/gxultd.png',
                voice: 'ğŸ‘¿ å“¼ï¼Œæœ¬å°å§ä»Šå¤©å¿ƒæƒ…ä¸é”™ï¼'
            },
            'bear': {
                img: 'https://img.baidu.re/i/2025/12/gxvoni.png',
                voice: 'ğŸ¥ å‘¼å‘¼...å¥½æƒ³åƒèœ‚èœœæ¾é¥¼å•Š...'
            },
            'clover': {
                img: 'https://img.baidu.re/i/2025/12/gxw6h4.png',
                voice: 'ğŸ€ ç»™ä½ å¸¦æ¥ä¸€ç‚¹ç‚¹å¹¸è¿å“¦ï¼'
            }
        };

        function toggleIsland() {
            islandState = !islandState;
            if (islandState) {
                island.classList.add('expanded');
                setTimeout(() => islandContent.style.display = 'flex', 200);
            } else {
                islandContent.style.display = 'none';
                island.classList.remove('expanded');
                audioBubble.style.display = 'none'; 
            }
        }

        function changeIsland(type, event) {
            if(event) event.stopPropagation(); 
            const config = islandConfig[type];
            if(config) {
                islandAvatar.src = config.img;
                audioBubble.innerText = config.voice;
                audioBubble.style.display = 'block';
                setTimeout(() => {
                    audioBubble.style.display = 'none';
                }, 3000);
            }
        }

        function updateText(val) {
            console.log("æ–‡æ¡ˆæ›´æ–°ä¸º:", val);
        }

        // === 3. APP æ‰“å¼€ä¸é€€å‡ºé€»è¾‘ (ä¿æŒä¸å˜) ===
        let navStack = []; 

        function openApp(appId) {
            const app = document.getElementById(appId);
            if(app) {
                app.style.display = 'flex'; 
                navStack.push(appId); 
                document.getElementById('homeBtn').classList.add('app-active');
                
                if (appId === 'ai-app') {
                    setupChatListeners();
                }
            }
        }

        function handleHomeClick(e) {
            if(e) e.stopPropagation(); 

            if (navStack.length > 0) {
                const currentAppId = navStack.pop();
                const currentApp = document.getElementById(currentAppId);
                if(currentApp) currentApp.style.display = 'none';

                if (navStack.length === 0) {
                    document.getElementById('homeBtn').classList.remove('app-active');
                }
            }
        }
        
        // -----------------------------------------------------
        // ä»¥ä¸‹æ˜¯è®¾ç½® App çš„å­é¡µé¢é…ç½®å’ŒåŠŸèƒ½é€»è¾‘
        // -----------------------------------------------------

        // 1. è¿”å›è®¾ç½®ä¸»èœå• (API å’Œå£çº¸æ¨¡å—å…±ç”¨)
        function showSettingsMainMenu(event) {
            if(event) event.preventDefault();
            document.getElementById('settings-sub-page').style.display = 'none';
            document.getElementById('settings-main-menu').style.display = 'block';
        }


        /* ======================================= */
        /* === 4. API é…ç½®æ¨¡å—å†…å®¹ (å·²å¢åŠ åŠ è½½å’Œä¿å­˜é€»è¾‘) === */
        /* ======================================= */

        const API_CONFIG_HTML = `
            <button class="api-button" onclick="showSettingsMainMenu(event)" style="width:auto; margin-bottom: 30px; background-color: #ddd; color: #333; padding: 8px 15px; font-size: 14px;">
                < è¿”å›ç³»ç»Ÿè®¾ç½®
            </button>
            <div class="api-settings-container">
                <h2>ğŸ¤– AI æœåŠ¡å•†é…ç½®</h2>
                
                <div class="setting-group">
                    <label for="api-provider" class="api-label">é€‰æ‹© API æœåŠ¡å•†ï¼š</label>
                    <select id="api-provider" class="api-select">
                        <option value="openai">GPT (OpenAI)</option>
                        <option value="gemini">Gemini (Google)</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="custom">è‡ªå®šä¹‰/å…¶ä»– (å…¬ç›Šç«™ç‚¹)</option>
                    </select>
                </div>
                
                <div class="setting-group">
                    <label for="api-key" class="api-label">API Key / å¯†é’¥ï¼š</label>
                    <input type="password" id="api-key" class="api-input" placeholder="è¯·è¾“å…¥æ‚¨çš„ API å¯†é’¥">
                </div>
                
                <div class="setting-group" id="custom-url-group" style="display:none;">
                    <label for="custom-url" class="api-label">API é€”å¾„ (ç«™ç‚¹ç½‘å€)ï¼š</label>
                    <input type="url" id="custom-url" class="api-input" placeholder="ä¾‹å¦‚: https://api.example.com/v1/chat/completions">
                </div>
                
                <div class="setting-group">
                    <label for="model-name" class="api-label">AI æ¨¡å‹åç§°ï¼š</label>
                    <select id="model-name" class="api-select">
                        <option value="gpt-4o">gpt-4o (OpenAI)</option>
                        <option value="gpt-3.5-turbo">gpt-3.5-turbo (OpenAI)</option>
                        <option value="gemini-2.5-flash">gemini-2.5-flash (Google)</option>
                        <option value="gemini-2.5-pro">gemini-2.5-pro (Google)</option>
                        <option value="deepseek-chat">deepseek-chat (DeepSeek)</option>
                        <option value="other-model">è‡ªå®šä¹‰æ¨¡å‹åç§°</option>
                    </select>
                </div>
                
                <button id="test-connection-btn" class="api-button">æµ‹è¯•å¹¶ä¿å­˜é…ç½®</button>
                
                <p id="connection-status" class="status-message">ç­‰å¾…æµ‹è¯•...</p>
            </div>
        `;

        function initializeApiSettingsInteractions() {
            const providerSelect = document.getElementById('api-provider');
            const urlGroup = document.getElementById('custom-url-group');
            const testBtn = document.getElementById('test-connection-btn');
            
            // --- **åŠ è½½å·²ä¿å­˜çš„é…ç½®å¹¶å¡«å……è¾“å…¥æ¡†** ---
            const savedProvider = loadSetting('api_provider');
            const savedKey = loadSetting('api_key');
            const savedUrl = loadSetting('api_url');
            const savedModel = loadSetting('api_model');

            if (savedProvider) document.getElementById('api-provider').value = savedProvider;
            if (savedKey) document.getElementById('api-key').value = savedKey;
            if (savedUrl) document.getElementById('custom-url').value = savedUrl;
            if (savedModel) document.getElementById('model-name').value = savedModel;
            // ---------------------------------------------------
            
            if(providerSelect) {
                providerSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        urlGroup.style.display = 'block';
                    } else {
                        urlGroup.style.display = 'none';
                    }
                });
                // ç¡®ä¿åŠ è½½æ—¶ä¹Ÿæ ¹æ® savedProvider æ­£ç¡®æ˜¾ç¤º/éšè— URL æ¡†
                if (document.getElementById('api-provider').value === 'custom') {
                    urlGroup.style.display = 'block';
                }
            }
            
            if (testBtn) {
                testBtn.addEventListener('click', function() {
                    const statusMsg = document.getElementById('connection-status');
                    statusMsg.className = 'status-message'; 
                    statusMsg.innerText = 'æ­£åœ¨æµ‹è¯•è¿æ¥...è¯·ç¨å€™ã€‚';
                    
                    // --- **è·å–æ‰€æœ‰é…ç½®å€¼** ---
                    const provider = document.getElementById('api-provider').value;
                    const apiKey = document.getElementById('api-key').value;
                    const customUrl = document.getElementById('custom-url').value;
                    const modelName = document.getElementById('model-name').value;
                    // --------------------------------

                    setTimeout(() => {
                        // ç®€å•çš„æœ¬åœ°éªŒè¯ï¼šåªè¦ Key ä¸ä¸ºç©ºï¼Œå°±è®¤ä¸ºé…ç½®ä¿å­˜æˆåŠŸ
                        if (apiKey && apiKey.length > 5) {
                            statusMsg.innerText = 'âœ… é…ç½®å·²ä¿å­˜ã€‚è¯·åœ¨ AI åŠ©æ‰‹ä¸­æµ‹è¯•è¿æ¥ã€‚';
                            statusMsg.classList.add('success');
                            
                            // --- **ä¿å­˜æ‰€æœ‰é…ç½®åˆ° localStorage** ---
                            saveSetting('api_provider', provider);
                            saveSetting('api_key', apiKey);
                            saveSetting('api_url', customUrl);
                            saveSetting('api_model', modelName);
                            // --------------------------------------------
                        } else {
                            statusMsg.innerText = 'âš ï¸ è¯·è¾“å…¥æ‚¨çš„ API Keyã€‚é…ç½®æœªä¿å­˜ã€‚';
                            statusMsg.classList.add('error');
                        }
                    }, 500); // å‡å°‘å»¶è¿Ÿ
                });
            }
        }

        // åŠ è½½ API é…ç½®ç•Œé¢
        function loadApiSettings(event) {
            if(event) event.preventDefault();
            const subPageContainer = document.getElementById('settings-sub-page');
            const mainMenu = document.getElementById('settings-main-menu');
            
            subPageContainer.innerHTML = API_CONFIG_HTML;
            
            mainMenu.style.display = 'none';
            subPageContainer.style.display = 'block';

            initializeApiSettingsInteractions(); 
        }

        /* ======================================= */
        /* === 5. å£çº¸é…ç½®æ¨¡å—å†…å®¹ (å·²å¢åŠ åŠ è½½é€»è¾‘) === */
        /* ======================================= */

        const WALLPAPER_CONFIG_HTML = `
            <button class="api-button" onclick="showSettingsMainMenu(event)" style="width:auto; margin-bottom: 30px; background-color: #ddd; color: #333; padding: 8px 15px; font-size: 14px;">
                < è¿”å›ç³»ç»Ÿè®¾ç½®
            </button>
            <div class="wallpaper-settings-container">
                <h2>ğŸ–¼ï¸ æ›´æ¢æ‰‹æœºå£çº¸</h2>
                
                <div class="setting-group">
                    <label for="wallpaper-file-upload" class="api-label">ä»ç›¸å†Œ/æœ¬åœ°é€‰æ‹©å›¾ç‰‡ï¼š</label>
                    <input type="file" id="wallpaper-file-upload" class="api-input" accept="image/*" style="border:none; padding-left:0;">
                    <p style="font-size:12px; color:#999; margin-top:5px;">å›¾ç‰‡åªå­˜å‚¨åœ¨æ‚¨çš„æµè§ˆå™¨ç¼“å­˜ä¸­ï¼Œä¸ä¼šè¢«ä¸Šä¼ ã€‚</p>
                </div>
                
                <div style="text-align:center; margin: 25px 0; color:#ccc;">â€” æˆ– â€”</div>

                <div class="setting-group">
                    <label for="wallpaper-url-input" class="api-label">è¾“å…¥ç½‘ç»œå›¾ç‰‡ URL åœ°å€ï¼š</label>
                    <input type="url" id="wallpaper-url-input" class="api-input" placeholder="ä¾‹å¦‚: https://example.com/new_bg.jpg">
                </div>

                <button class="api-button" onclick="applyWallpaperFromUrl()">åº”ç”¨ç½‘ç»œå›¾ç‰‡ä¸ºå£çº¸</button>
                
                <div style="text-align:center; margin: 25px 0; color:#ccc;">â€” æˆ– â€”</div>
                
                <div class="setting-group">
                    <label class="api-label">é€‰æ‹©é¢„è®¾å£çº¸ï¼š</label>
                    <div id="preset-wallpaper-list" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                        <img src="https://img.baidu.re/i/2025/12/guvqaq.jpeg" class="preset-wallpaper-thumb" onclick="applyWallpaperUrl('https://img.baidu.re/i/2025/12/guvqaq.jpeg')">
                        <img src="https://img.baidu.re/i/2025/12/gyw9xz.jpeg" class="preset-wallpaper-thumb" onclick="applyWallpaperUrl('https://img.baidu.re/i/2025/12/gyw9xz.jpeg')">
                        <img src="https://img.baidu.re/i/2025/12/gw2t70.jpeg" class="preset-wallpaper-thumb" onclick="applyWallpaperUrl('https://img.baidu.re/i/2025/12/gw2t70.jpeg')">
                    </div>
                </div>
            </div>
        `;

        // åŠ è½½å£çº¸è®¾ç½®ç•Œé¢
        function openWallpaperSettings(event) {
            if(event) event.preventDefault();
            const subPageContainer = document.getElementById('settings-sub-page');
            const mainMenu = document.getElementById('settings-main-menu');
            
            subPageContainer.innerHTML = WALLPAPER_CONFIG_HTML;
            
            mainMenu.style.display = 'none';
            subPageContainer.style.display = 'block';

            // è¿è¡Œæ ¸å¿ƒäº¤äº’é€»è¾‘
            initializeWallpaperInteractions();
        }

        // 1. URL æ¨¡å¼ï¼šåº”ç”¨é€šè¿‡è¾“å…¥æ¡†ç²˜è´´çš„ URL
        function applyWallpaperFromUrl() {
            const urlInput = document.getElementById('wallpaper-url-input');
            const url = urlInput.value.trim();
            if (url) {
                applyNewWallpaper(url);
                urlInput.value = ''; 
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡ URL åœ°å€ï¼');
            }
        }

        // 2. é¢„è®¾æ¨¡å¼ï¼šåº”ç”¨é¢„è®¾æˆ–å¤–éƒ¨ç‚¹å‡»çš„ URL
        function applyWallpaperUrl(url) {
            if (url) {
                applyNewWallpaper(url);
            }
        }

        // 3. æ ¸å¿ƒå‡½æ•°ï¼šå®é™…æ›´æ¢å±å¹•èƒŒæ™¯ (æ–°å¢ä¿å­˜)
        function applyNewWallpaper(source) {
            const screen = document.querySelector('.screen');
            screen.style.backgroundImage = `url('${source}')`;
            screen.style.backgroundRepeat = 'no-repeat';
            screen.style.backgroundPosition = 'center center';
            screen.style.backgroundSize = 'cover';
            
            // --- **ä¿å­˜å£çº¸ URL åˆ° localStorage** ---
            saveSetting('wallpaper_url', source);
            // -------------------------------------------
            
            alert('âœ… å£çº¸å·²æ›´æ¢æˆåŠŸå¹¶ä¿å­˜ï¼');
            showSettingsMainMenu(); 
        }
        
        // 4. é¡µé¢åŠ è½½æ—¶æ‰§è¡Œï¼šåŠ è½½å·²ä¿å­˜çš„å£çº¸
        function loadSavedWallpaper() {
            const savedUrl = loadSetting('wallpaper_url');
            const screen = document.querySelector('.screen');
            const defaultUrl = 'https://img.baidu.re/i/2025/12/guvqaq.jpeg'; // é»˜è®¤å£çº¸ URL

            if (savedUrl) {
                // å¦‚æœæ‰¾åˆ°å·²ä¿å­˜çš„ URLï¼Œåˆ™åº”ç”¨å®ƒ
                screen.style.backgroundImage = `url('${savedUrl}')`;
                screen.style.backgroundRepeat = 'no-repeat';
                screen.style.backgroundPosition = 'center center';
                screen.style.backgroundSize = 'cover';
            } else {
                // å¦åˆ™åº”ç”¨é»˜è®¤å£çº¸
                screen.style.backgroundImage = `url('${defaultUrl}')`;
            }
        }

        // 5. åˆå§‹åŒ–æ–‡ä»¶é€‰æ‹©å™¨äº¤äº’ (å¤„ç†æœ¬åœ°æ–‡ä»¶ä¸Šä¼ )
        function initializeWallpaperInteractions() {
            const fileInput = document.getElementById('wallpaper-file-upload');
            
            if (fileInput) {
                fileInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            applyNewWallpaper(e.target.result);
                        };
                        reader.readAsDataURL(file); 
                    }
                });
            }
        }
        
        // [TODO: å…¶ä»–è®¾ç½®åŠŸèƒ½å ä½å‡½æ•°]
        function openWidgetSettings(event) {
            event.preventDefault();
            alert('å³å°†æ‰“å¼€å°ç»„ä»¶ç®¡ç†ç•Œé¢...');
        }

        /* ======================================= */
        /* === 6. AI èŠå¤©æ¶ˆæ¯å‘é€é€»è¾‘ (å®ç° API æ¥å…¥) === */
        /* ======================================= */

        // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºæ¶ˆæ¯æ°”æ³¡çš„ HTML ç»“æ„
        function createMessageElement(message, isUser) {
            const row = document.createElement('div');
            row.className = `message-row ${isUser ? 'right' : 'left'}`;
            
            const userAvatar = 'https://img.baidu.re/i/2025/12/gxultd.png'; 
            const aiAvatar = 'https://img.baidu.re/i/2025/12/gyw9xz.jpeg'; 

            let html = '';
            if (!isUser) {
                html += `<img src="${aiAvatar}" class="avatar" alt="AI Avatar">`;
            }
            
            html += `<div class="message-bubble">${message}</div>`;
            
            if (isUser) {
                html += `<img src="${userAvatar}" class="avatar" alt="User Avatar">`;
            }

            row.innerHTML = html;
            return row;
        }

        // æ ¸å¿ƒå‡½æ•°ï¼šå‘é€æ¶ˆæ¯å¹¶è§¦å‘ API è¯·æ±‚
        function sendMessage() {
            const inputElement = document.getElementById('chat-input');
            const container = document.getElementById('ai-chat-container');
            const messageText = inputElement.value.trim();

            if (messageText === "") {
                return; 
            }

            // 1. ç”Ÿæˆç”¨æˆ·æ¶ˆæ¯æ°”æ³¡
            const userMessage = createMessageElement(messageText, true);
            container.appendChild(userMessage);

            // 2. æ¸…ç©ºè¾“å…¥æ¡†
            inputElement.value = '';

            // 3. è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom(container);
            
            // 4. **[æ ¸å¿ƒ]** å‘é€çœŸæ­£çš„ API è¯·æ±‚
            fetchAiResponse(messageText, container);
        }

        // å¼‚æ­¥æ ¸å¿ƒå‡½æ•°ï¼šä¸ AI æœåŠ¡å™¨é€šä¿¡
        async function fetchAiResponse(userPrompt, container) {
            // 1. è·å–ç”¨æˆ·é…ç½®
            const config = getCurrentApiConfig();
            
            if (!config.key) {
                const errorMsg = "è¯·å…ˆåœ¨â€œè®¾ç½®â€ä¸­é…ç½®æ‚¨çš„ API å¯†é’¥ï¼";
                container.appendChild(createMessageElement(errorMsg, false));
                scrollToBottom(container);
                return;
            }
            
            // 2. æ ¹æ®æœåŠ¡å•†ç¡®å®š API ç›®æ ‡å’Œæ ¼å¼
            let apiEndpoint;
            let headers = {};
            let body = {};

            switch (config.provider) {
                case 'openai':
                case 'deepseek':
                case 'custom':
                    // **æ³¨æ„ï¼šDeepSeek å’Œè®¸å¤šå…¬ç›Šç«™ç‚¹çš„ API æ ¼å¼ä¸ OpenAI å…¼å®¹ã€‚**
                    
                    // ç¡®å®š API ç»ˆç«¯ç‚¹
                    apiEndpoint = config.provider === 'custom' ? config.url : 
                                  config.provider === 'deepseek' ? 'https://api.deepseek.com/v1/chat/completions' : 
                                  'https://api.openai.com/v1/chat/completions';
                    
                    // å¦‚æœæ˜¯è‡ªå®šä¹‰ URLï¼Œå¹¶ä¸”æ²¡æœ‰å¡«å†™å®Œæ•´è·¯å¾„ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªé»˜è®¤çš„ OpenAI å…¼å®¹è·¯å¾„
                    if (config.provider === 'custom' && !apiEndpoint.toLowerCase().includes('/chat/completions')) {
                         apiEndpoint = apiEndpoint.replace(/\/+$/, "") + '/v1/chat/completions';
                    }

                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.key}`
                    };
                    
                    body = {
                        model: config.model || 'gpt-4o', 
                        messages: [{ role: "user", content: userPrompt }]
                    };
                    break;
                    
                case 'gemini':
                    // **æ³¨æ„ï¼šè¿™æ˜¯ Gemini API çš„ç®€åŒ–æ ¼å¼**
                    apiEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${config.model || 'gemini-2.5-flash'}:generateContent?key=${config.key}`;
                    
                    headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    body = {
                        contents: [{ role: "user", parts: [{ text: userPrompt }] }]
                    };
                    break;
                    
                default:
                    const unknownMsg = `æœªçŸ¥çš„ AI æœåŠ¡å•†: ${config.provider}ã€‚è¯·æ£€æŸ¥è®¾ç½®ï¼`;
                    container.appendChild(createMessageElement(unknownMsg, false));
                    scrollToBottom(container);
                    return;
            }
            
            // 3. å‘é€è¯·æ±‚å¹¶å¤„ç†å›å¤
            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });
                
                // æ£€æŸ¥ HTTP çŠ¶æ€ç 
                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(`API é”™è¯¯: ${response.status} - ${errorJson.error?.message || response.statusText}`);
                }
                
                const data = await response.json();
                let aiText = "æœªèƒ½è·å–åˆ°å›å¤ã€‚"; 
                
                // è§£æå›å¤æ–‡æœ¬ (æ ¹æ®ä¸åŒçš„ API æ ¼å¼)
                if (config.provider === 'gemini') {
                    // Gemini çš„å›å¤è·¯å¾„
                    aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || aiText;
                } else {
                    // OpenAI/DeepSeek/Custom çš„å›å¤è·¯å¾„
                    aiText = data.choices?.[0]?.message?.content || aiText;
                }

                // 4. æ˜¾ç¤º AI æ¶ˆæ¯
                container.appendChild(createMessageElement(aiText, false));

            } catch (error) {
                const errorDetail = `è¿æ¥å¤±è´¥æˆ–å¯†é’¥é”™è¯¯ï¼š${error.message}`;
                container.appendChild(createMessageElement(errorDetail, false));
                console.error("AI API Call Failed:", error);

            } finally {
                // ç¡®ä¿æœ€ç»ˆæ»šåŠ¨åˆ°åº•éƒ¨
                scrollToBottom(container);
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom(element) {
            element.scrollTop = element.scrollHeight;
        }

        // è¾…åŠ©å‡½æ•°ï¼šç›‘å¬è¾“å…¥æ¡†å’ŒæŒ‰é’®
        function setupChatListeners() {
            const sendBtn = document.getElementById('send-btn');
            const inputElement = document.getElementById('chat-input');
            
            sendBtn.onclick = sendMessage;

            inputElement.onkeyup = function(event) {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            };
        }
        
    </script>
</body>
</html>
