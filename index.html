<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„AIå°æ‰‹æœº</title>
    <style>
        /* ======================================= */
        /* === å­—ä½“è®¾ç½® === */
        /* ======================================= */
        @font-face {
            font-family: 'GenYoGothicTW'; 
            /* å‡è®¾ GenYoGothicTW-R.ttf æ”¾åœ¨äº†æ ¹ç›®å½• */
            src: url('GenYoGothicTW-R.ttf') format('truetype'); 
            font-weight: normal;
            font-style: normal;
        }

        /* === åŸºç¡€è®¾ç½® === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background-color: #f0f2f5;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; 
            font-family: 'GenYoGothicTW', "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", sans-serif;
            overflow: hidden; 
        }

        /* === æ‰‹æœºå¤–å£³ === */
        .phone-case {
            width: 320px; height: 650px;
            background: #111;
            border-radius: 45px;
            box-shadow: 0 0 0 10px #333, 0 20px 50px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
            border: 2px solid #444;
            transition: all 0.3s ease-out;
        }

        /* === å±å¹•åŒºåŸŸ === */
        .screen {
            width: 100%; height: 100%;
            /* é»˜è®¤å£çº¸æˆ–åŠ è½½ä¿å­˜çš„å£çº¸ */
            background: url('https://img.baidu.re/i/2025/12/zcj2xa.jpeg') no-repeat center center/cover;
            position: relative; overflow: hidden;
            transition: background-image 0.5s ease;
        }
        
        /* ======================================= */
        /* === 1. é¡¶éƒ¨çŠ¶æ€æ  === */
        /* ======================================= */
        .status-bar-area {
            position: absolute; top: 0; left: 0; width: 100%; height: 40px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px 0 25px;
            font-size: 13px; color: white;
            z-index: 500; font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.6);
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        /* ======================================= */
        /* === 2. çµåŠ¨å²› === */
        /* ======================================= */
        .dynamic-island-trigger {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            width: 100px; height: 30px;
            background: #000; border-radius: 20px;
            z-index: 600; cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; justify-content: center;
            background-size: cover; background-position: center;
        }
        .island-avatar { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 5px; object-fit: cover; border: 2px solid #fff; }
        .dynamic-island-trigger.expanded {
            width: 280px; height: 170px; 
            border-radius: 35px; padding: 15px;
            flex-direction: column; justify-content: flex-start;
            background-color: #000;
        }
        .island-content {
            display: none; flex-direction: column; align-items: center;
            width: 100%; height: 100%; color: white;
            animation: fadeIn 0.3s ease;
        }

        /* ======================================= */
        /* === 3. æ¡Œé¢ (User Profile Widget ä¿®æ­£) === */
        /* ======================================= */
        .desktop-slider {
            display: flex;
            height: calc(100% - 50px); 
            width: 100%; 
            overflow-x: auto; 
            scroll-snap-type: x mandatory; 
            scrollbar-width: none; 
            padding-top: 60px;
            padding-bottom: 20px;
            z-index: 10;
        }
        .page {
            min-width: 100%; 
            height: 100%;
            scroll-snap-align: start; 
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: repeat(4, 80px);
            gap: 10px 0;
            padding: 20px 10px;
            align-content: start;
            overflow-y: auto; 
        }

        .widget-area {
            grid-column: 1 / 5;
            display: flex; justify-content: center; align-items: flex-start;
            margin-bottom: 10px; 
        }
        .user-profile-widget {
            width: 90%;
            height: 150px;
            background: rgba(255, 255, 255, 0.2);
            /* ç¡®ä¿å³ä½¿å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œåº•è‰²ä¹Ÿèƒ½æä¾›è§†è§‰æ•ˆæœ */
            background-color: rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 18px;
            padding: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            overflow: hidden; /* è§£å†³èƒŒæ™¯å›¾å¯èƒ½æº¢å‡ºçš„é—®é¢˜ */
        }
        .widget-avatar {
            width: 50px; height: 50px; border-radius: 50%;
            border: 3px solid white; object-fit: cover;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .widget-id { font-size: 18px; font-weight: bold; }
        .widget-signature { font-size: 12px; opacity: 0.9; margin-top: 2px; }
        
        .app-icon {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; text-decoration: none; color: white;
            font-size: 11px; text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            margin-bottom: 0; cursor: pointer;
        }
        .app-icon img {
            width: 52px; height: 52px; border-radius: 12px; margin-bottom: 5px;
            background: rgba(255,255,255,0.2); object-fit: cover;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .app-icon:active img { filter: brightness(0.8); transform: scale(0.95); }

        /* ======================================= */
        /* === 4. åº”ç”¨çª—å£ä¸èŠå¤©ç•Œé¢ (äº¤äº’å†²çªä¿®å¤ä¿æŒ) === */
        /* ======================================= */
        .app-window {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 800;
            display: none; flex-direction: column;
            animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .app-header {
            height: 80px; background: #f8f8f8;
            padding-top: 40px; text-align: center; font-weight: bold;
            border-bottom: 1px solid #eee;
            position: relative;
        }
        .chat-container {
            flex: 1; overflow-y: auto; padding: 10px; background-color: #f7f7f7; 
        }
        .chat-input-area {
            min-height: 50px; 
            background-color: #f9f9f9;
            border-top: 1px solid #ddd;
            display: flex;
            align-items: flex-start; 
            /* å…³é”®ï¼šåº•éƒ¨å¡«å…… 20px é¿å¼€ Home Indicator åŒºåŸŸ */
            padding: 5px 10px 20px 10px; 
            position: relative; 
            z-index: 9998; 
        }
        .message-row .avatar {
            width: 35px; height: 35px; border-radius: 50%; object-fit: cover;
        }
        /* æ¨¡æ‹Ÿé”®ç›˜å¼¹èµ·æ—¶çš„æ•ˆæœ */
        .keyboard-up #ai-app {
            height: calc(100% - 250px); 
        }

        /* === 5. åº•éƒ¨ç™½æ¡ (home-indicator) === */
        .home-indicator {
            position: absolute; bottom: 0; left: 0; width: 100%; 
            height: 30px; 
            display: flex; justify-content: center; align-items: flex-end;
            padding-bottom: 10px; 
            z-index: 9999; 
            cursor: pointer;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .home-bar {
            width: 130px; height: 5px; background: white;
            border-radius: 100px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            pointer-events: none;
        }

        /* ======================================= */
        /* === è®¾ç½®èœå•å’Œ API ç•Œé¢æ ·å¼ (ä¿æŒä¸å˜) === */
        /* ======================================= */
        h2 { margin-bottom: 20px; letter-spacing: 0.5px; }
        .setting-link-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 0; color: #333; text-decoration: none;
            border-bottom: 1px solid #f0f0f0; font-size: 16px; 
        }
        .api-input, .api-select {
            display: block; width: 100%; padding: 12px 12px; font-size: 15px;
            border: 1px solid #ddd; border-radius: 10px; 
        }
        .api-button {
            width: 100%; padding: 14px; margin-top: 15px; font-size: 16px;
            border: none; border-radius: 10px; background-color: #007aff;
            color: white; cursor: pointer; transition: 0.2s; letter-spacing: 0.8px; 
        }
        .status-message.success { background-color: #e6ffed; color: #008000; padding: 8px; border-radius: 5px; }
        .status-message.error { background-color: #ffe6e6; color: #d90000; padding: 8px; border-radius: 5px; }
        
        /* --- User Profile App æ ·å¼ --- */
        .profile-preview {
            display: flex; flex-direction: column; align-items: center;
            padding: 30px 0; background-color: #f0f0f0; border-radius: 10px;
            margin-bottom: 20px;
        }
        .profile-preview-avatar {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            border: 4px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .profile-bg-preview {
            width: 100%; height: 100px; background-size: cover; background-position: center;
            border-radius: 10px; margin-top: 10px; border: 1px dashed #ccc;
        }
        
    </style>
</head>
<body onload="initialize()"> 
    <div class="phone-case" id="phoneCase">
        <div class="screen">
            
            <div class="status-bar-area">
                <span id="clock">12:00</span>
                <span class="status-icons">
                    <span id="weather">â˜€ï¸</span> 
                    <span id="battery">100%ğŸ”‹</span>
                    <span>ğŸ“¶</span>
                </span>
            </div>

            <div class="dynamic-island-trigger" id="island" onclick="toggleIsland()">
                <div class="island-content" id="islandContent" onclick="event.stopPropagation()">
                    <img src="https://img.baidu.re/i/2025/12/gxultd.png" id="islandAvatar" class="island-avatar">
                    <div id="audioBubble" class="audio-bubble"></div>
                    <div class="island-btn-group">
                        <img src="https://img.baidu.re/i/2025/12/gxultd.png" class="img-btn" onclick="changeIsland('kuromi', event)">
                        <img src="https://img.baidu.re/i/2025/12/gxvoni.png" class="img-btn" onclick="changeIsland('bear', event)">
                        <img src="https://img.baidu.re/i/2025/12/gxw6h4.png" class="img-btn" onclick="changeIsland('clover', event)">
                    </div>
                    <input type="text" class="island-input" placeholder="ç‚¹å‡»è¿™é‡Œä¿®æ”¹æ–‡æ¡ˆ..." onchange="updateText(this.value)">
                </div>
            </div>

            <div class="desktop-slider" id="desktopSlider">
                
                <div class="page page-1">
                    <div class="widget-area" style="grid-row: 1 / 3; height: 100%;">
                        <div class="user-profile-widget" id="userProfileWidget" onclick="openApp('user-profile-app')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <img src="" id="widgetAvatar" class="widget-avatar">
                                <div class="widget-info">
                                    <span id="widgetId" class="widget-id">User10086</span>
                                    <span id="widgetSignature" class="widget-signature">ç­‰å¾…ä¸ªç­¾...</span>
                                </div>
                            </div>
                            <div style="font-size: 12px; opacity: 0.8;">ç‚¹å‡»è¿›å…¥ä¸ªäººä¸»é¡µ ></div>
                        </div>
                    </div>
                    
                    <div style="grid-row: 3; grid-column: 1;"></div>
                    <div style="grid-row: 3; grid-column: 2;"></div>
                    <div style="grid-row: 3; grid-column: 3;"></div>
                    <div style="grid-row: 3; grid-column: 4;"></div>

                    <div class="app-icon" onclick="openApp('ai-app')" style="grid-row: 4; grid-column: 1;">
                        <img src="https://img.baidu.re/i/2025/12/gw1n4f.jpeg">
                        <span>AIåŠ©æ‰‹</span>
                    </div>
                    <div class="app-icon" onclick="openApp('settings-app')" style="grid-row: 4; grid-column: 2;">
                        <img src="https://img.baidu.re/i/2025/12/gvj0se.jpeg">
                        <span>è®¾ç½®</span>
                    </div>
                    <div class="app-icon" onclick="openApp('gallery-app')" style="grid-row: 4; grid-column: 3;">
                        <img src="https://img.baidu.re/i/2025/12/gw27ij.jpeg">
                        <span>ç›¸å†Œ</span>
                    </div>
                    <div class="app-icon" onclick="openApp('music-app')" style="grid-row: 4; grid-column: 4;">
                        <img src="https://img.baidu.re/i/2025/12/gw2drc.jpeg">
                        <span>éŸ³ä¹</span>
                    </div>
                    
                    <div style="grid-row: 5; grid-column: 1 / 5;"></div>
                </div>

                <div class="page page-2">
                    <div class="app-icon" onclick="openApp('forum-app')" style="grid-row: 1; grid-column: 1;">
                        <img src="https://img.baidu.re/i/2025/12/gw2t70.jpeg">
                        <span>è®ºå›</span>
                    </div>
                    <div class="app-icon" onclick="openApp('extra-app')" style="grid-row: 1; grid-column: 2;">
                        <img src="https://img.baidu.re/i/2025/12/gw34t4.jpeg">
                        <span>ç•ªå¤–å‰§åœº</span>
                    </div>
                    <div style="grid-row: 3; grid-column: 1 / 5; text-align:center; color:rgba(255,255,255,0.5);">
                        <div style="font-size:40px; margin-bottom:10px;">ğŸ“…</div>
                        <span>å¾…åŠäº‹é¡¹</span>
                    </div>
                </div>

            </div>
            
            <div class="page-indicator" id="pageIndicator">
                <span class="active"></span>
                <span></span>
            </div>

            <div id="ai-app" class="app-window">
                <div class="app-header">
                    <div class="app-status-bar"><span id="chat-clock">12:00</span> <span class="status-icons"><span>100%ğŸ”‹</span><span>ğŸ“¶</span></span></div>
                    AI èŠå¤©åŠ©æ‰‹
                </div>
                
                <div class="chat-container" id="ai-chat-container">
                    <div class="message-row left">
                        <img src="https://img.baidu.re/i/2025/12/gyw9xz.jpeg" class="avatar" alt="AI Avatar">
                        <div class="message-bubble">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI èŠå¤©åŠ©æ‰‹ï¼Œè¯·å¼€å§‹å’Œæˆ‘èŠå¤©å§ã€‚</div>
                    </div>
                </div>
                
                <div class="chat-input-area">
                    <span class="chat-action-btn">ğŸ¤</span>
                    <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." onfocus="simulateKeyboardUp()" onblur="simulateKeyboardDown()">
                    <span class="chat-action-btn send-btn" id="send-btn">å‘é€</span>
                </div>
                
            </div>
            
            <div id="user-profile-app" class="app-window">
                <div class="app-header">
                    <div class="app-status-bar"><span id="profile-clock">12:00</span> <span class="status-icons"><span>100%ğŸ”‹</span><span>ğŸ“¶</span></span></div>
                    ä¸ªäººä¸»é¡µè®¾ç½®
                </div>
                <div class="app-body">
                    <div class="profile-preview">
                        <img src="" id="appProfileAvatar" class="profile-preview-avatar">
                        <span id="appProfileId" class="profile-preview-id">User10086</span>
                        <span id="appProfileSig" class="profile-preview-sig">ä¸€ä¸ªç­‰å¾… API Key çš„æ‰‹æœºå£³ã€‚</span>
                        <div id="profileBgPreview" class="profile-bg-preview"></div>
                    </div>
                    
                    <div class="setting-group">
                        <label for="profile-id" class="api-label">ğŸ‘¤ æ˜µç§°/IDï¼š</label>
                        <input type="text" id="profile-id" class="api-input" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°">
                    </div>
                    <div class="setting-group">
                        <label for="profile-signature" class="api-label">âœï¸ ä¸ªäººç­¾åï¼š</label>
                        <input type="text" id="profile-signature" class="api-input" placeholder="è¯·è¾“å…¥ä½ çš„ä¸ªäººç­¾å">
                    </div>
                    <div class="setting-group">
                        <label for="profile-avatar" class="api-label">ğŸ–¼ï¸ å¤´åƒ URLï¼š</label>
                        <input type="url" id="profile-avatar" class="api-input" placeholder="è¯·è¾“å…¥å¤´åƒå›¾ç‰‡åœ°å€">
                    </div>
                    <div class="setting-group">
                        <label for="profile-background" class="api-label">ğŸŒ„ ä¸»é¡µèƒŒæ™¯ URLï¼š</label>
                        <input type="url" id="profile-background" class="api-input" placeholder="è¯·è¾“å…¥èƒŒæ™¯å›¾ç‰‡åœ°å€">
                    </div>

                    <button class="api-button" onclick="saveUserProfile(event)" style="background-color: #ff9500; margin-top: 20px;">
                        ä¿å­˜ä¸ªäººä¿¡æ¯å¹¶åº”ç”¨
                    </button>
                    <p id="profile-status" class="status-message" style="margin-top:10px; text-align:center; font-size:12px;">æ›´æ”¹å°†ç«‹å³ç”Ÿæ•ˆã€‚</p>
                </div>
            </div>
            
            <div id="settings-app" class="app-window">
                <div class="app-header">
                    <div class="app-status-bar"><span id="settings-clock">12:00</span> <span class="status-icons"><span>100%ğŸ”‹</span><span>ğŸ“¶</span></span></div>
                    ç³»ç»Ÿè®¾ç½®
                </div>
                <div class="app-body">
                    <div id="settings-main-menu">
                        <a href="#" onclick="loadApiSettings(event)" class="setting-link-item">
                            <span class="text">ğŸ¤– AI æœåŠ¡å•†é…ç½®</span>
                            <span class="arrow">></span>
                        </a>
                        <a href="#" onclick="openWallpaperSettings(event)" class="setting-link-item">
                            <span class="text">ğŸ“± ä¿®æ”¹æ‰‹æœºå£çº¸</span>
                            <span class="arrow">></span>
                        </a>
                        <a href="#" onclick="openWidgetSettings(event)" class="setting-link-item">
                            <span class="text">ğŸ§© å°ç»„ä»¶ç®¡ç†</span>
                            <span class="arrow">></span>
                        </a>
                    </div>
                    <div id="settings-sub-page" style="display:none;"></div>
                </div>
            </div>
            
            <div id="gallery-app" class="app-window"><div class="app-header"><div class="app-status-bar"><span>12:00</span> <span class="status-icons"><span>100%ğŸ”‹</span><span>ğŸ“¶</span></span></div>æˆ‘çš„ç›¸å†Œ</div><div class="app-body">ç›¸å†Œå†…å®¹åŠ è½½ä¸­...</div></div>
            <div id="music-app" class="app-window"><div class="app-header"><div class="app-status-bar"><span>12:00</span> <span class="status-icons"><span>100%ğŸ”‹</span><span>ğŸ“¶</span></span></div>éŸ³ä¹æ’­æ”¾å™¨</div><div class="app-body">ğŸµ æ­£åœ¨æ’­æ”¾: With You</div></div>
            <div id="forum-app" class="app-window"><div class="app-header"><div class="app-status-bar"><span>12:00</span> <span class="status-icons"><span>100%ğŸ”‹</span><span>ğŸ“¶</span></span></div>ç¤¾åŒºè®ºå›</div><div class="app-body">æ¬¢è¿æ¥åˆ°è®¨è®ºåŒº...</div></div>
            <div id="extra-app" class="app-window"><div class="app-header"><div class="app-status-bar"><span>12:00</span> <span class="status-icons"><span>100%ğŸ”‹</span><span>ğŸ“¶</span></span></div>ç•ªå¤–å‰§åœº</div><div class="app-body">é€‰æ‹©ä½ çš„è§’è‰²æ‰®æ¼”å‰§æœ¬...</div></div>

            <div class="home-indicator" id="homeBtn" onclick="handleHomeClick(event)">
                <div class="home-bar"></div>
            </div>

        </div>
    </div>

    <script>
        // =====================================================
        // === [æŒä¹…åŒ–] å…¨å±€åˆå§‹åŒ–å’Œè¾…åŠ©å‡½æ•° ===
        // =====================================================
        // ä¿®æ­£é»˜è®¤ç”¨æˆ·å¤´åƒ URLï¼Œç¡®ä¿å®ƒæ˜¯ä¸€ä¸ªå¯ç”¨çš„å›¾ç‰‡
        const defaultAiAvatar = 'https://img.baidu.re/i/2025/12/gyw9xz.jpeg'; 
        const defaultUserAvatar = 'https://img.baidu.re/i/2025/12/user-default-avatar.png'; // å‡è®¾è¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é»˜è®¤å¤´åƒ URL
        const defaultWallpaper = 'https://img.baidu.re/i/2025/12/zcj2xa.jpeg';

        const defaultProfile = {
            id: 'User10086',
            avatar: defaultUserAvatar, 
            signature: 'ä¸€ä¸ªç­‰å¾…API Keyçš„æ‰‹æœºå£³ã€‚',
            background: defaultWallpaper
        };

        function loadSetting(key) {
            try { return localStorage.getItem(key); } catch (e) { console.error("æ— æ³•è®¿é—® localStorage: ", e); return null; }
        }
        function saveSetting(key, value) {
            try { localStorage.setItem(key, value); } catch (e) { console.error("æ— æ³•ä¿å­˜åˆ° localStorage: ", e); }
        }
        
        function loadUserProfile() {
            const profile = {};
            profile.id = loadSetting('profile_id') || defaultProfile.id;
            profile.avatar = loadSetting('profile_avatar') || defaultProfile.avatar;
            profile.signature = loadSetting('profile_signature') || defaultProfile.signature;
            profile.background = loadSetting('profile_background') || defaultProfile.background;
            return profile;
        }

        function updateProfileDisplay(profile) {
            // æ¡Œé¢ Widget æ›´æ–°
            const widget = document.getElementById('userProfileWidget');
            if(widget) {
                document.getElementById('widgetId').innerText = profile.id;
                document.getElementById('widgetSignature').innerText = profile.signature;
                document.getElementById('widgetAvatar').src = profile.avatar;
                widget.style.backgroundImage = `url('${profile.background}')`;
            }
        }

        function initialize() {
            // 1. åŠ è½½ç”¨æˆ·é…ç½®å’Œæ˜¾ç¤º
            const userProfile = loadUserProfile();
            loadSavedWallpaper(); 
            updateProfileDisplay(userProfile); 
            
            // 2. åˆå§‹åŒ– Profile App å­—æ®µ (ç¡®ä¿å…ƒç´ å­˜åœ¨)
            if(document.getElementById('profile-id')) {
                document.getElementById('profile-id').value = userProfile.id;
                document.getElementById('profile-signature').value = userProfile.signature;
                document.getElementById('profile-avatar').value = userProfile.avatar === defaultUserAvatar ? '' : userProfile.avatar;
                document.getElementById('profile-background').value = userProfile.background === defaultWallpaper ? '' : userProfile.background;
                
                // åˆå§‹åŒ– Profile App é¢„è§ˆ
                document.getElementById('appProfileAvatar').src = userProfile.avatar;
                document.getElementById('appProfileId').innerText = userProfile.id;
                document.getElementById('appProfileSig').innerText = userProfile.signature;
                document.getElementById('profileBgPreview').style.backgroundImage = `url('${userProfile.background}')`;
            }
            
            // 3. å…¶ä»–åˆå§‹åŒ–
            updateTime(); 
            setupPageIndicator();
            setupScrollListener();
            setupChatListeners();
        }
        
        // =====================================================
        // === User Profile App é€»è¾‘ ===
        // =====================================================
        function saveUserProfile(event) {
            if(event) event.preventDefault();
            
            const newId = document.getElementById('profile-id').value.trim() || defaultProfile.id;
            const newSig = document.getElementById('profile-signature').value.trim() || defaultProfile.signature;
            let newAvatar = document.getElementById('profile-avatar').value.trim();
            let newBg = document.getElementById('profile-background').value.trim();

            if (!newAvatar) newAvatar = defaultProfile.avatar;
            if (!newBg) newBg = defaultProfile.background;

            saveSetting('profile_id', newId);
            saveSetting('profile_signature', newSig);
            saveSetting('profile_avatar', newAvatar);
            saveSetting('profile_background', newBg);
            
            const updatedProfile = { id: newId, signature: newSig, avatar: newAvatar, background: newBg };
            
            updateProfileDisplay(updatedProfile);
            
            // æ›´æ–° Profile App é¢„è§ˆ
            document.getElementById('appProfileAvatar').src = updatedProfile.avatar;
            document.getElementById('appProfileId').innerText = updatedProfile.id;
            document.getElementById('appProfileSig').innerText = updatedProfile.signature;
            document.getElementById('profileBgPreview').style.backgroundImage = `url('${updatedProfile.background}')`;

            const statusMsg = document.getElementById('profile-status');
            statusMsg.innerText = 'âœ… ä¸ªäººä¿¡æ¯å·²ä¿å­˜å¹¶åº”ç”¨ï¼';
            statusMsg.classList.add('success');
            setTimeout(() => {
                statusMsg.innerText = 'æ›´æ”¹å°†ç«‹å³ç”Ÿæ•ˆã€‚';
                statusMsg.classList.remove('success');
            }, 3000);
        }

        // =====================================================
        // === API é…ç½®æ¨¡å— (æ ¸å¿ƒä¿®å¤ï¼šåŠ¨æ€æ¨¡å‹æ¨¡æ‹Ÿä¿æŒä¸å˜) ===
        // =====================================================
        
        const API_CONFIG_HTML = `
            <button class="api-button" onclick="showSettingsMainMenu(event)" style="width:auto; margin-bottom: 30px; background-color: #ddd; color: #333; padding: 8px 15px; font-size: 14px;">
                < è¿”å›ç³»ç»Ÿè®¾ç½®
            </button>
            <div class="api-settings-container">
                <h2>ğŸ¤– AI æœåŠ¡å•†é…ç½®</h2>
                
                <div class="setting-group">
                    <label for="api-provider" class="api-label">é€‰æ‹© API æœåŠ¡å•†ï¼š</label>
                    <select id="api-provider" class="api-select">
                        <option value="openai">GPT (OpenAI)</option>
                        <option value="gemini">Gemini (Google)</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="custom">è‡ªå®šä¹‰/å…¶ä»– (å…¬ç›Šç«™ç‚¹)</option>
                    </select>
                </div>
                
                <div class="setting-group">
                    <label for="api-key" class="api-label">API Key / å¯†é’¥ï¼š</label>
                    <input type="password" id="api-key" class="api-input" placeholder="è¯·è¾“å…¥æ‚¨çš„ API å¯†é’¥">
                </div>
                
                <div class="setting-group" id="custom-url-group">
                    <label for="custom-url" class="api-label">API é€”å¾„ (ç«™ç‚¹ç½‘å€)ï¼š</label>
                    <input type="url" id="custom-url" class="api-input" placeholder="ä¾‹å¦‚: https://api.example.com/v1/chat/completions">
                </div>
                
                <div class="setting-group">
                    <label for="model-name" class="api-label">AI æ¨¡å‹åç§°ï¼š</label>
                    <select id="model-name" class="api-select">
                        <option value="key-specified">ğŸ—ï¸ ä½¿ç”¨ Key é™„å¸¦çš„æ¨¡å‹</option> 
                        <option value="gpt-4o">gpt-4o (OpenAI)</option>
                        <option value="gpt-3.5-turbo">gpt-3.5-turbo (OpenAI)</option>
                        <option value="gemini-2.5-flash">gemini-2.5-flash (Google)</option>
                        <option value="deepseek-chat">deepseek-chat (DeepSeek)</option>
                        <option value="custom-model">è‡ªå®šä¹‰æ¨¡å‹åç§°</option>
                    </select>
                </div>
                
                <button id="test-connection-btn" class="api-button">æµ‹è¯•å¹¶ä¿å­˜é…ç½®</button>
                
                <p id="connection-status" class="status-message">ç­‰å¾…æµ‹è¯•...</p>
            </div>
        `;

        function initializeApiSettingsInteractions() {
            const testBtn = document.getElementById('test-connection-btn');
            
            const savedProvider = loadSetting('api_provider');
            const savedKey = loadSetting('api_key');
            const savedUrl = loadSetting('api_url');
            const savedModel = loadSetting('api_model');

            // æ¢å¤ä¿å­˜çš„å€¼
            if (savedProvider) document.getElementById('api-provider').value = savedProvider;
            if (savedKey) document.getElementById('api-key').value = savedKey;
            if (savedUrl) document.getElementById('custom-url').value = savedUrl;
            if (savedModel) {
                const modelSelect = document.getElementById('model-name');
                if (!Array.from(modelSelect.options).some(opt => opt.value === savedModel)) {
                    const newOption = new Option(savedModel, savedModel, true, true);
                    modelSelect.add(newOption);
                }
                modelSelect.value = savedModel;
            }
            
            if (testBtn) {
                testBtn.addEventListener('click', function() {
                    const statusMsg = document.getElementById('connection-status');
                    statusMsg.className = 'status-message'; 
                    statusMsg.innerText = 'æ­£åœ¨æµ‹è¯•è¿æ¥...è¯·ç¨å€™ã€‚';
                    
                    const provider = document.getElementById('api-provider').value;
                    const apiKey = document.getElementById('api-key').value;
                    let customUrl = document.getElementById('custom-url').value;
                    let modelName = document.getElementById('model-name').value;
                    
                    if (!customUrl && provider !== 'custom') {
                        customUrl = `[ä½¿ç”¨ ${provider} çš„é»˜è®¤ URL]`; 
                    }
                    
                    if (modelName === 'custom-model') {
                         const userDefinedModel = prompt("è¯·è¾“å…¥æ‚¨çš„è‡ªå®šä¹‰æ¨¡å‹åç§°ï¼š");
                         if (userDefinedModel) {
                             modelName = userDefinedModel.trim();
                             const modelSelect = document.getElementById('model-name');
                             if (!Array.from(modelSelect.options).some(opt => opt.value === modelName)) {
                                 const newOption = new Option(modelName, modelName, true, true);
                                 modelSelect.add(newOption);
                             }
                             modelSelect.value = modelName;
                         } else {
                             modelName = 'key-specified';
                             document.getElementById('model-name').value = 'key-specified';
                         }
                    }

                    setTimeout(() => {
                        if (apiKey && apiKey.length > 5) {
                            statusMsg.innerText = `âœ… é…ç½®å·²ä¿å­˜ã€‚Keyé•¿åº¦ï¼š${apiKey.length}ã€‚æ¨¡å‹è®¾å®šä¸ºï¼š${modelName}ã€‚`;
                            statusMsg.classList.add('success');
                            
                            saveSetting('api_provider', provider);
                            saveSetting('api_key', apiKey);
                            saveSetting('api_url', customUrl);
                            saveSetting('api_model', modelName);
                        } else {
                            statusMsg.innerText = 'âš ï¸ è¯·è¾“å…¥æ‚¨çš„ API Keyã€‚é…ç½®æœªä¿å­˜ã€‚';
                            statusMsg.classList.add('error');
                        }
                    }, 500);
                });
            }
        }

        function loadApiSettings(event) {
            if(event) event.preventDefault();
            const subPageContainer = document.getElementById('settings-sub-page');
            const mainMenu = document.getElementById('settings-main-menu');
            
            subPageContainer.innerHTML = API_CONFIG_HTML;
            
            mainMenu.style.display = 'none';
            subPageContainer.style.display = 'block';

            initializeApiSettingsInteractions(); 
        }

        // =====================================================
        // === èŠå¤©æ¶ˆæ¯å‘é€é€»è¾‘ (ä½¿ç”¨å…¨å±€ Profile æ•°æ®) ===
        // =====================================================

        function createMessageElement(message, isUser) {
            const row = document.createElement('div');
            row.className = `message-row ${isUser ? 'right' : 'left'}`;
            
            const profile = loadUserProfile();
            const userAvatar = profile.avatar;
            const aiAvatar = defaultAiAvatar; 
            
            let html = '';
            if (!isUser) { html += `<img src="${aiAvatar}" class="avatar" alt="AI Avatar">`; }
            html += `<div class="message-bubble">${message}</div>`;
            if (isUser) { html += `<img src="${userAvatar}" class="avatar" alt="User Avatar">`; }
            row.innerHTML = html;
            return row;
        }

        function sendMessage() {
            const inputElement = document.getElementById('chat-input');
            const container = document.getElementById('ai-chat-container');
            const messageText = inputElement.value.trim();

            if (messageText === "") {
                return; 
            }

            const userMessage = createMessageElement(messageText, true);
            container.appendChild(userMessage);

            inputElement.value = '';

            scrollToBottom(container);
            
            fetchAiResponse(messageText, container);
        }

        async function fetchAiResponse(userPrompt, container) {
            const config = getCurrentApiConfig();
            
            if (!config.key) {
                const errorMsg = "è¯·å…ˆåœ¨â€œè®¾ç½®â€ä¸­é…ç½®æ‚¨çš„ API å¯†é’¥ï¼";
                container.appendChild(createMessageElement(errorMsg, false));
                scrollToBottom(container);
                return;
            }
            
            const profile = loadUserProfile();
            
            const loadingMsg = createMessageElement('æ­£åœ¨æ€è€ƒä¸­...', false);
            container.appendChild(loadingMsg);
            scrollToBottom(container);
            
            // æ¨¡æ‹Ÿ AI å›åº”
            setTimeout(() => {
                container.removeChild(loadingMsg);
                const response = `æˆ‘æ”¶åˆ°äº†ä½ çš„æ¶ˆæ¯ï¼š${userPrompt}ã€‚
                ï¼ˆAI çŸ¥é“ä½ çš„IDæ˜¯ ${profile.id}ï¼Œæ¨¡å‹æ˜¯ ${config.model}ï¼Œå¹¶ä½¿ç”¨ URL ${config.url} è¿›è¡Œé€šä¿¡ï¼‰`;
                container.appendChild(createMessageElement(response, false));
                scrollToBottom(container);
            }, 1000); 
        }

        // =====================================================
        // === é€šç”¨å‡½æ•° (ä¿æŒä¸å˜) ===
        // =====================================================
        const phoneCase = document.getElementById('phoneCase');
        let navStack = []; 

        function getCurrentApiConfig() { 
            return { 
                provider: loadSetting('api_provider'), 
                key: loadSetting('api_key'), 
                url: loadSetting('api_url'), 
                model: loadSetting('api_model') 
            }; 
        }

        function setupChatListeners() {
            const sendBtn = document.getElementById('send-btn');
            const inputElement = document.getElementById('chat-input');
            
            sendBtn.onclick = sendMessage;

            inputElement.onkeyup = function(event) {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            };
        }

        function simulateKeyboardUp() { 
            phoneCase.classList.add('keyboard-up'); 
            setTimeout(() => scrollToBottom(document.getElementById('ai-chat-container')), 300); 
        }
        function simulateKeyboardDown() { 
            phoneCase.classList.remove('keyboard-up'); 
        }
        function scrollToBottom(element) { 
            element.scrollTop = element.scrollHeight; 
        }

        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            
            document.getElementById('clock').innerText = timeStr;
            const appTimeSpans = document.querySelectorAll('.app-status-bar > span:first-child');
            appTimeSpans.forEach(span => { span.innerText = timeStr; });
            
            const weathers = ['â˜€ï¸', 'â˜ï¸', 'ğŸŒ§ï¸', 'âš¡', 'â„ï¸', 'ğŸŒˆ'];
            if(now.getSeconds() % 10 === 0 && now.getSeconds() !== updateTime.lastSecond) {
                document.getElementById('weather').innerText = weathers[Math.floor(Math.random() * weathers.length)];
                updateTime.lastSecond = now.getSeconds();
            }
        }
        updateTime.lastSecond = -1; 
        setInterval(updateTime, 1000);

        function openApp(appId) {
            const app = document.getElementById(appId);
            if(app) {
                if (navStack.length > 0) {
                    const currentApp = document.getElementById(navStack[navStack.length - 1]);
                    if(currentApp) currentApp.style.display = 'none';
                }

                app.style.display = 'flex'; 
                navStack.push(appId); 
                document.getElementById('homeBtn').classList.add('app-active');
                
                if (appId === 'ai-app') {
                    scrollToBottom(document.getElementById('ai-chat-container'));
                }
                if (appId === 'user-profile-app') {
                     // ç¡®ä¿è¿›å…¥ Profile é¡µé¢æ—¶åŠ è½½æœ€æ–°æ•°æ®
                     initialize();
                }
            }
        }

        function handleHomeClick(e) {
            if(e) e.stopPropagation(); 
            
            if (navStack.length > 0) {
                const currentAppId = navStack.pop();
                const currentApp = document.getElementById(currentAppId);
                
                if(currentApp) {
                    currentApp.style.display = 'none';
                    if (currentAppId === 'ai-app') {
                        phoneCase.classList.remove('keyboard-up');
                        document.getElementById('chat-input').blur();
                    }
                }
                
                if (navStack.length > 0) {
                    const prevApp = document.getElementById(navStack[navStack.length - 1]);
                    if(prevApp) prevApp.style.display = 'flex';
                } else {
                    document.getElementById('homeBtn').classList.remove('app-active');
                }
            }
        }
        
        function setupPageIndicator() { /* ... */ }
        function setupScrollListener() { /* ... */ }
        function toggleIsland() { /* ... */ }
        function changeIsland(type, event) { /* ... */ }
        function updateText(val) { /* ... */ }
        function loadSavedWallpaper() { /* ... */ }
        function openWallpaperSettings(event) { /* ... */ }
        function openWidgetSettings(event) { /* ... */ alert('å³å°†æ‰“å¼€å°ç»„ä»¶ç®¡ç†ç•Œé¢...');}
        function showSettingsMainMenu(event) { 
            if(event) event.preventDefault();
            document.getElementById('settings-sub-page').style.display = 'none';
            document.getElementById('settings-main-menu').style.display = 'block';
        }
        
    </script>
</body>
</html>
